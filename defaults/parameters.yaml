# TIP: To check your parameters before running, use: `snakemake -c 1 print_config`

# -----------------------------------------------------------------------------
# Inputs
# -----------------------------------------------------------------------------

# These are the datasets, actual files, you are providing as input.

# name                 : Builds will use this to specify the input
# type                 : can be any combination of local,usher
# metadata (local)     : path to metadata for local input
# sequences (local)    : path to sequences for local input
# metadata_url (usher) : url to metadata for usher input
# pb_url (usher)       : url to protobuf for usher input
# ver_url (usher)      : url to version info for usher input

inputs:

  # A selection of publicly available samples (genbank) that have been posted
  # to https://github.com/cov-lineages/pango-designation
  - name: controls
    type:
      - local
    metadata: data/controls/metadata.tsv
    sequences: data/controls/sequences.fasta

  # An UShER base phylogeny of all publicly available samples (genbank).
  # The protobuf will be downloaded to: `data/public-latest/usher.pb.gz
  # The metadata will be downloaded to: `data/public-latest/usher.metadata.tsv
  - name: public-latest
    type:
      - usher

    # Latest: Not version controlled!
    # pb_url: http://hgdownload.soe.ucsc.edu/goldenPath/wuhCor1/UShER_SARS-CoV-2/public-latest.all.masked.pb.gz
    # metadata_url: http://hgdownload.soe.ucsc.edu/goldenPath/wuhCor1/UShER_SARS-CoV-2/public-latest.metadata.tsv.gz
    # ver_url: http://hgdownload.soe.ucsc.edu/goldenPath/wuhCor1/UShER_SARS-CoV-2/public-latest.version.txt

    # Date: Version controlled option
    metadata_url: http://hgdownload.soe.ucsc.edu/goldenPath/wuhCor1/UShER_SARS-CoV-2/2022/04/02/public-2022-04-02.metadata.tsv.gz
    pb_url: http://hgdownload.soe.ucsc.edu/goldenPath/wuhCor1/UShER_SARS-CoV-2/2022/04/02/public-2022-04-02.all.masked.pb.gz
    ver_url: http://hgdownload.soe.ucsc.edu/goldenPath/wuhCor1/UShER_SARS-CoV-2/2022/04/02/public-2022-04-02.version.txt

# -----------------------------------------------------------------------------
# Rule Parameters
# -----------------------------------------------------------------------------

# These are rule-based parameterization that will apply to ALL builds.
# If a parameter is not listed here, it cannot be customized.

# name    : The rule to apply the parameters to.
# <param> : The parameter name as specified in `workflow/Snakefile`.

rule_params:

  # tag : datestamp of dataset (run `nextclade dataset list` for more info)
  # dataset: The nextclade dataset to use as the reference
  - name: nextclade_dataset
    dataset: sars-cov-2
    tag: "2022-03-31T12:00:00Z"

  # nextclade_ref  : The header of the reference used by nextclade
  # custom_ref     : The header of the reference in `data/reference/reference.fasta`.
  - name: nextclade
    nextclade_ref: "MN908947 \\(Wuhan-Hu-1/2019\\)"
    custom_ref: "Wuhan/Hu-1/2019"

  # exclude_clades : Exclude strains that are recombinants of these clades
  - name: nextclade_recombinants
    exclude_clades:
        - "19" # From 2019
        - "20A" # Non-VoC From 2020
        - "20B"
        - "20C"
        - "20D"
        - "20E"
        - "20F"
        - "20G"

  # max_name_length : The maximum character length of strain names
  # sc2rf_args      : Additional arguments supplied to the program sc2rf
  # debug_args      : Ultra-sensitive arguments for debugging
  - name: sc2rf
    max_name_length: 50
    sc2rf_args: ""
    debug_args: "--ansi --parents 1-10 --breakpoints 0-100 --unique 1 --max-ambiguous 1000 --max-intermission-length 1 --max-intermission-count 999 --mutation-threshold 0.5"

  # min_len: Ignore recombinants regions shorter than this
  - name: sc2rf_recombinants
    min_len: 100

  # k : The number of contextual samples to select when extracting subtrees.
  - name: usher_subtree
    k: 50

  # extra_cols : Extra columns from the metadata to output (csv)
  - name: summary
    extra_cols: "date,country"

# -----------------------------------------------------------------------------
# Builds
# -----------------------------------------------------------------------------

# These are the analyses, you want to run.

# name       : A directory will be created as results/{name}
# base_input : The base phylogeny for UShER, must be an input with type "usher"

builds:

  # `controls` is the default build and will always run.
  # It uses the `controls` input as experimental samples to analyze, and places
  # them on a a base UShER phylogeny using the `public-latest` datest.

  - name: controls
    base_input: public-latest

    # Universal rule parameters can (optionally) be overridden for a specific build.
    sc2rf:
      sc2rf_args: "--ansi --parents 2-4 --breakpoints 1-4 --unique 1 --max-intermission-length 3 --max-intermission-count 3 --mutation-threshold 0.5"
